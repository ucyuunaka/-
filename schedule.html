<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>课表 - 课堂助手</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <!-- 添加页脚样式 -->
    <link rel="stylesheet" href="css/footer.css" />
    <!-- 添加滚动动画样式 -->
    <link rel="stylesheet" href="css/scrollAnimation.css" />
    <!-- 添加主题样式 -->
    <link rel="stylesheet" href="css/themes/themes.css" />
    <!-- 使用图标库 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- 添加 Remix Icon 库，用于侧边栏图标 -->
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <!-- 添加页面特定样式 -->
    <link rel="stylesheet" href="css/pages/schedule.css" />
  </head>
  <body>
    <!-- 侧边栏导航 - 只保留容器元素 -->
    <aside class="sidebar"></aside>

    <!-- 移动端菜单切换按钮 -->
    <div class="sidebar-toggle">
      <i class="ri-menu-line"></i>
    </div>

    <!-- 移动端遮罩层 -->
    <div class="sidebar-overlay"></div>
    <!-- 主要内容 -->
    <div class="container py-4 sidebar-active">
      <!-- 页面标题和描述 -->
      <div class="page-header">
        <div class="container">
          <h1 class="mb-2 animate-on-scroll fade-up">我的课程表</h1>
          <p class="text-secondary animate-on-scroll fade-up delay-100">
            管理和安排你的课程，清晰掌握每周学习时间
          </p>
        </div>
      </div>

      <div class="schedule-container">
        <!-- 课表控制区域 -->
        <div class="schedule-controls animate-on-scroll fade-up">
          <div class="view-toggle">
            <button class="active" id="week-view">周视图</button>
            <button id="list-view">列表视图</button>
          </div>

          <div class="schedule-actions">
            <button class="btn" id="add-course-btn">
              <i class="fas fa-plus"></i> 添加课程
            </button>

            <div class="import-export">
              <div class="export-dropdown">
                <button class="btn btn-outline">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="export-dropdown-content">
                  <a href="#" id="export-ical">
                    <i class="far fa-calendar"></i> 导出为iCal
                  </a>
                  <a href="#" id="export-csv">
                    <i class="far fa-file-excel"></i> 导出为CSV
                  </a>
                  <a href="#" id="import-courses">
                    <i class="fas fa-file-import"></i> 导入课程
                  </a>
                  <a href="#" id="print-schedule">
                    <i class="fas fa-print"></i> 打印课表
                  </a>
                  <a href="#" id="clear-schedule" class="text-danger">
                    <i class="fas fa-trash-alt"></i> 清空课表
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 周视图课表 -->
        <div
          id="week-view-container"
          class="animate-on-scroll fade-up delay-100"
        >
          <div class="timetable">
            <div class="timetable-grid" id="timetable-grid">
              <!-- 表头将由JavaScript动态生成 -->
            </div>
          </div>
        </div>

        <!-- 列表视图 -->
        <div
          id="list-view-container"
          style="display: none"
          class="animate-on-scroll fade-up delay-100"
          id="list-container"
        >
          <!-- 列表视图内容将由JavaScript动态生成 -->
        </div>
      </div>
    </div>

    <!-- 添加课程弹窗 -->
    <div class="modal" id="add-course-modal">
      <div class="modal-content">
        <div class="modal-close" id="close-course-modal">×</div>
        <h2 class="mb-3">添加新课程</h2>
        <form id="add-course-form">
          <div class="form-group">
            <label class="form-label" for="course-name">课程名称</label>
            <input
              type="text"
              class="form-control"
              id="course-name"
              placeholder="例如：高等数学"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group col-6">
              <label class="form-label" for="course-teacher">授课教师</label>
              <input
                type="text"
                class="form-control"
                id="course-teacher"
                placeholder="例如：张教授"
              />
            </div>
            <div class="form-group col-6">
              <label class="form-label" for="course-location">上课地点</label>
              <input
                type="text"
                class="form-control"
                id="course-location"
                placeholder="例如：理学楼101"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-6">
              <label class="form-label" for="course-day">星期几</label>
              <select class="form-control" id="course-day" required>
                <option value="">请选择</option>
                <option value="1">星期一</option>
                <option value="2">星期二</option>
                <option value="3">星期三</option>
                <option value="4">星期四</option>
                <option value="5">星期五</option>
                <option value="6">星期六</option>
                <option value="7">星期日</option>
              </select>
            </div>
            <div class="form-group col-6">
              <label class="form-label" for="course-time">课程节数</label>
              <select class="form-control" id="course-time" required>
                <option value="">请选择</option>
                <option value="1">第1节 (8:00-8:45)</option>
                <option value="2">第2节 (8:55-9:40)</option>
                <option value="3">第3节 (10:00-10:45)</option>
                <option value="4">第4节 (10:55-11:40)</option>
                <option value="5">第5节 (14:00-14:45)</option>
                <option value="6">第6节 (14:55-15:40)</option>
                <option value="7">第7节 (16:00-16:45)</option>
                <option value="8">第8节 (16:55-17:40)</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="course-weeks">上课周数</label>
            <input
              type="text"
              class="form-control"
              id="course-weeks"
              placeholder="例如：1-16周 或 1,3,5,7,9,11,13,15周"
            />
          </div>

          <div class="form-group">
            <label class="form-label">课程颜色</label>
            <div class="color-options">
              <div
                class="color-option selected"
                style="background-color: #e1f1ff"
                data-class="course-math"
              ></div>
              <div
                class="color-option"
                style="background-color: #feedc9"
                data-class="course-physics"
              ></div>
              <div
                class="color-option"
                style="background-color: #d7f8e8"
                data-class="course-chemistry"
              ></div>
              <div
                class="color-option"
                style="background-color: #ffe2ec"
                data-class="course-biology"
              ></div>
              <div
                class="color-option"
                style="background-color: #e6e6ff"
                data-class="course-literature"
              ></div>
              <div
                class="color-option"
                style="background-color: #f2e8ff"
                data-class="course-history"
              ></div>
              <div
                class="color-option"
                style="background-color: #e0f7fa"
                data-class="course-english"
              ></div>
              <!-- 添加新的颜色选项 -->
              <div
                class="color-option"
                style="background-color: #e6f7ff"
                data-class="course-computer"
              ></div>
              <div
                class="color-option"
                style="background-color: #fff1f0"
                data-class="course-art"
              ></div>
              <div
                class="color-option"
                style="background-color: #f9f0ff"
                data-class="course-music"
              ></div>
              <div
                class="color-option"
                style="background-color: #f0f5ff"
                data-class="course-sports"
              ></div>
              <div
                class="color-option"
                style="background-color: #fff0f6"
                data-class="course-politics"
              ></div>
              <div
                class="color-option"
                style="background-color: #f4ffb8"
                data-class="course-geography"
              ></div>
            </div>
            <input type="hidden" id="course-color" value="course-math" />
          </div>

          <div class="form-group">
            <label class="form-label" for="course-notes">备注</label>
            <textarea
              class="form-control"
              id="course-notes"
              placeholder="添加其他信息（可选）"
            ></textarea>
          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn">保存课程</button>
            <button type="button" class="btn btn-outline" id="cancel-course">
              取消
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 页脚 - 简化为只保留容器 -->
    <footer class="footer"></footer>
    <script src="js/main.js"></script>
    <script src="js/sidebar.js"></script>
    <!-- 添加页脚脚本 -->
    <script src="js/footer.js"></script>
    <!-- 添加滚动动画脚本 -->
    <script src="js/scrollAnimation.js"></script>
    <!-- 添加主题管理脚本 -->
    <script src="js/themes.js"></script>
    <!-- 添加课表模块脚本 -->
    <script type="module">
      // 导入课表数据和相关函数
      import {
        scheduleData,
        addCourse,
        deleteCourse,
        clearCourses,
        updateCourse,
      } from "./js/data/schedule_data.js";

      document.addEventListener("DOMContentLoaded", function () {
        // 初始化滚动动画
        initScrollAnimation(".animate-on-scroll", {
          threshold: 0.1,
          once: true,
        });

        // 添加课程弹窗
        const addCourseBtn = document.getElementById("add-course-btn");
        const addCourseModal = document.getElementById("add-course-modal");
        const closeCourseModal = document.getElementById("close-course-modal");
        const cancelCourse = document.getElementById("cancel-course");
        const addCourseForm = document.getElementById("add-course-form");

        // 视图切换
        const weekViewBtn = document.getElementById("week-view");
        const listViewBtn = document.getElementById("list-view");
        const weekViewContainer = document.getElementById(
          "week-view-container"
        );
        const listViewContainer = document.getElementById(
          "list-view-container"
        );

        // 颜色选择功能
        const colorOptions = document.querySelectorAll(".color-option");
        const courseColorInput = document.getElementById("course-color"); // 使用从js/data/schedule_data.js导入的课表数据

        // 初始化课表数据
        function loadScheduleData() {
          try {
            console.log("正在初始化课表数据...");
            // 直接使用已经内联的scheduleData
            renderTimetable();
            renderListView();
            setupCourseCardEvents();
            console.log("课表数据初始化成功");
          } catch (error) {
            console.error("初始化课表数据失败:", error);
            document.getElementById("week-view-container").innerHTML = `
            <div class="alert alert-danger">
              <h4>初始化数据失败</h4>
              <p>${error.message}</p>
              <p>请检查控制台获取详细信息</p>
            </div>
          `;
            showNotification("初始化课表数据失败，请刷新页面重试", "error");
          }
        }

        // 渲染周视图课表
        function renderTimetable() {
          const timetableGrid = document.getElementById("timetable-grid");
          if (!timetableGrid) return;

          // 清空现有内容
          timetableGrid.innerHTML = "";

          // 添加表头
          timetableGrid.appendChild(createHeader());

          // 添加时间行和课程单元格
          scheduleData.timePeriods.forEach((period) => {
            // 添加时间单元格
            const timeCell = document.createElement("div");
            timeCell.className = "timetable-time";
            timeCell.textContent = period.time;
            timetableGrid.appendChild(timeCell);

            // 为每一天添加课程单元格
            for (let dayId = 1; dayId <= 7; dayId++) {
              const cell = document.createElement("div");
              cell.className = "timetable-cell";
              cell.setAttribute("data-day", dayId);
              cell.setAttribute("data-time", period.id);
              timetableGrid.appendChild(cell);

              // 查找并显示该单元格对应的课程
              const coursesInCell = scheduleData.courses.filter(
                (course) =>
                  course.day === dayId &&
                  course.startTime <= period.id &&
                  course.endTime >= period.id
              );

              if (coursesInCell.length > 0) {
                coursesInCell.forEach((course) => {
                  // 只在连续课程的第一个时间段显示课程卡片
                  if (period.id === course.startTime) {
                    cell.appendChild(createCourseCard(course));
                  }
                });
              }
            }
          });
        }

        // 创建表头
        function createHeader() {
          const headerFragment = document.createDocumentFragment();

          // 时间表头
          const timeHeader = document.createElement("div");
          timeHeader.className = "timetable-header";
          timeHeader.textContent = "时间";
          headerFragment.appendChild(timeHeader);

          // 星期表头
          scheduleData.days.forEach((day) => {
            const dayHeader = document.createElement("div");
            dayHeader.className = "timetable-header";
            dayHeader.textContent = day.name;
            headerFragment.appendChild(dayHeader);
          });

          return headerFragment;
        } // 创建课程卡片
        function createCourseCard(course) {
          const card = document.createElement("div");
          card.className = `course-card ${course.color}`;
          card.setAttribute("data-course-id", course.id);

          card.innerHTML = `
          <div class="course-title">${course.title}</div>
          <div class="course-info">${course.teacher}</div>
          <div class="course-location">
            <i class="fas fa-map-marker-alt"></i> ${course.location}
          </div>
        `;

          if (course.weeks) {
            const weeksInfo = document.createElement("div");
            weeksInfo.className = "course-info";
            weeksInfo.textContent = course.weeks;
            card.appendChild(weeksInfo);
          }

          // 添加字体自适应逻辑
          adjustFontSize(card);

          return card;
        }        // 根据内容自动调整字体大小的函数
        function adjustFontSize(card) {
          const titleElement = card.querySelector(".course-title");
          const infoElements = card.querySelectorAll(".course-info");
          const locationElement = card.querySelector(".course-location");

          // 设置最小字体大小和基准字体大小
          const minFontSize = 0.65; // rem - 允许较小的字体以确保完整显示
          const baseTitleSize = 0.95; // rem
          const baseInfoSize = 0.8; // rem

          try {
            // 调整标题字体大小 - 确保始终缩放过长标题以全部显示（关键修复）
            if (titleElement) {
              // 对所有课程名称应用自适应字体大小，不设置长度阈值
              const titleLength = titleElement.textContent.length;
              
              // 基于字符数量动态计算字体大小
              let scaleFactor = 1;
              if (titleLength > 6) {
                // 字符越多，缩放比例越大
                scaleFactor = Math.min(1, 6 / titleLength + 0.2);
              }
              
              const newSize = Math.max(minFontSize, baseTitleSize * scaleFactor);
              titleElement.style.fontSize = `${newSize}rem`;
            }

            // 调整其他信息字体大小 - 只对特别长的内容进行缩放
            infoElements.forEach((element) => {
              if (element && element.textContent.length > 18) {
                const scaleFactor = Math.min(1, 18 / element.textContent.length);
                const newSize = Math.max(minFontSize, baseInfoSize * scaleFactor);
                element.style.fontSize = `${newSize}rem`;
              }
            });

            // 调整位置信息字体大小 - 只对特别长的内容进行缩放
            if (
              locationElement &&
              locationElement.textContent.trim().length > 18
            ) {
              const scaleFactor = Math.min(
                1,
                18 / locationElement.textContent.trim().length
              );
              const newSize = Math.max(minFontSize, baseInfoSize * scaleFactor);
              locationElement.style.fontSize = `${newSize}rem`;
            }
          } catch (e) {
            console.error("调整字体大小发生错误:", e);
            // 错误恢复 - 不要让字体调整影响整个卡片的显示
          }
        }

        // 渲染列表视图
        function renderListView() {
          const listContainer = document.getElementById("list-view-container");
          if (!listContainer) return;

          // 清空现有内容
          listContainer.innerHTML = "";

          // 按天组织课程
          const coursesByDay = {};
          scheduleData.days.forEach((day) => {
            coursesByDay[day.id] = [];
          });

          scheduleData.courses.forEach((course) => {
            if (coursesByDay[course.day]) {
              coursesByDay[course.day].push(course);
            }
          });

          // 为每一天创建卡片
          scheduleData.days.forEach((day) => {
            // 如果该天没有课程，跳过
            if (coursesByDay[day.id].length === 0) return;

            // 创建该天的卡片
            const dayCard = document.createElement("div");
            dayCard.className = day.id === 1 ? "card" : "card mt-4";

            // 添加标题
            const dayTitle = document.createElement("h3");
            dayTitle.className = "mb-3";
            dayTitle.textContent = day.name;
            dayCard.appendChild(dayTitle);

            // 添加该天的课程
            coursesByDay[day.id]
              .sort((a, b) => a.startTime - b.startTime)
              .forEach((course) => {
                const courseWrapper = document.createElement("div");
                courseWrapper.className = "mb-3";

                const timeRange = getTimeRangeText(course);

                const courseCard = document.createElement("div");
                courseCard.className = `course-card ${course.color}`;
                courseCard.setAttribute("data-course-id", course.id);

                courseCard.innerHTML = `
                <div class="course-title">${course.title}</div>
                <div class="course-info">${course.teacher}</div>
                <div class="course-info">${timeRange}</div>
                <div class="course-location">
                  <i class="fas fa-map-marker-alt"></i> ${course.location}
                </div>
              `;

                if (course.weeks) {
                  const weeksInfo = document.createElement("div");
                  weeksInfo.className = "course-info";
                  weeksInfo.textContent = course.weeks;
                  courseCard.appendChild(weeksInfo);
                }

                courseWrapper.appendChild(courseCard);
                dayCard.appendChild(courseWrapper);
              });

            listContainer.appendChild(dayCard);
          });
        }

        // 获取课程时间范围文本
        function getTimeRangeText(course) {
          if (scheduleData.timePeriods && scheduleData.timePeriods.length > 0) {
            const startPeriod = scheduleData.timePeriods.find(
              (period) => period.id === course.startTime
            );
            const endPeriod = scheduleData.timePeriods.find(
              (period) => period.id === course.endTime
            );

            if (startPeriod && endPeriod) {
              const startTime = startPeriod.time.split("-")[0];
              const endTime = endPeriod.time.split("-")[1];
              return `${startTime}-${endTime}`;
            }
          }

          return `第${course.startTime}-${course.endTime}节`;
        }

        // 设置课程卡片事件
        function setupCourseCardEvents() {
          // 动态绑定所有课程卡片点击事件
          document.addEventListener("click", function (e) {
            const courseCard = e.target.closest(".course-card");
            if (courseCard) {
              const courseId = courseCard.getAttribute("data-course-id");
              if (courseId) {
                const course = scheduleData.courses.find(
                  (c) => c.id == courseId
                );
                if (course) {
                  showCourseDetails(course);
                }
              }
            }
          });
        }

        // 显示课程详情
        function showCourseDetails(course) {
          // 可以在这里实现课程详情查看功能
          // 例如：弹出模态框显示课程详细信息
          console.log("查看课程详情:", course);
        }

        // 打开添加课程弹窗
        addCourseBtn.addEventListener("click", function () {
          addCourseModal.style.display = "flex";
        });

        // 关闭添加课程弹窗
        function closeModal() {
          addCourseModal.style.display = "none";
          addCourseForm.reset();
          // 重置颜色选择
          colorOptions.forEach((option) => option.classList.remove("selected"));
          colorOptions[0].classList.add("selected");
          courseColorInput.value = "course-math";
        }

        // 关闭按钮事件
        closeCourseModal.addEventListener("click", closeModal);
        cancelCourse.addEventListener("click", closeModal);

        // 点击外部关闭弹窗
        window.addEventListener("click", function (event) {
          if (event.target === addCourseModal) {
            closeModal();
          }
        });

        // 切换课表视图
        weekViewBtn.addEventListener("click", function () {
          weekViewBtn.classList.add("active");
          listViewBtn.classList.remove("active");
          weekViewContainer.style.display = "block";
          listViewContainer.style.display = "none";
        });

        listViewBtn.addEventListener("click", function () {
          listViewBtn.classList.add("active");
          weekViewBtn.classList.remove("active");
          listViewContainer.style.display = "block";
          weekViewContainer.style.display = "none";
        });

        // 颜色选择逻辑
        colorOptions.forEach((option) => {
          option.addEventListener("click", function () {
            // 移除其他选中状态
            colorOptions.forEach((opt) => opt.classList.remove("selected"));
            // 添加当前选中状态
            this.classList.add("selected");
            // 更新隐藏字段的值
            courseColorInput.value = this.getAttribute("data-class");
          });
        });

        // 添加课程表单提交
        addCourseForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          // 获取表单数据
          const courseName = document.getElementById("course-name").value;
          const courseTeacher = document.getElementById("course-teacher").value;
          const courseLocation =
            document.getElementById("course-location").value;
          const courseDay = parseInt(
            document.getElementById("course-day").value,
            10
          );
          const courseTime = parseInt(
            document.getElementById("course-time").value,
            10
          );
          const courseColor = document.getElementById("course-color").value;
          const courseWeeks =
            document.getElementById("course-weeks").value || "1-16周";

          // 创建新课程对象
          const newCourse = {
            id:
              scheduleData.courses.length > 0
                ? Math.max(...scheduleData.courses.map((c) => c.id)) + 1
                : 1,
            title: courseName,
            teacher: courseTeacher,
            location: courseLocation,
            color: courseColor,
            day: courseDay,
            startTime: courseTime,
            endTime: courseTime,
            weeks: courseWeeks,
          };

          // 添加到课程数据中
          scheduleData.courses.push(newCourse);

          // 更新视图
          renderTimetable();
          renderListView();

          // 保存数据到服务器/本地
          try {
            // 这里可以添加保存到服务器的代码
            // 模拟保存成功
            showNotification("课程添加成功！", "success");
          } catch (error) {
            console.error("保存课程失败:", error);
            showNotification("保存课程失败，请重试", "error");
          }

          // 关闭弹窗
          closeModal();
        });

        // 导出和清空事件
        document
          .getElementById("export-ical")
          .addEventListener("click", function (e) {
            e.preventDefault();
            alert("导出为iCal功能正在开发中...");
          });

        document
          .getElementById("export-csv")
          .addEventListener("click", function (e) {
            e.preventDefault();
            alert("导出为CSV功能正在开发中...");
          });

        document
          .getElementById("import-courses")
          .addEventListener("click", function (e) {
            e.preventDefault();
            alert("导入课程功能正在开发中...");
          });

        document
          .getElementById("print-schedule")
          .addEventListener("click", function (e) {
            e.preventDefault();
            window.print();
          });

        document
          .getElementById("clear-schedule")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (confirm("确定要清空所有课程吗？此操作无法撤销。")) {
              // 清空课程数据
              scheduleData.courses = [];

              // 更新视图
              renderTimetable();
              renderListView();

              // 这里可以添加将清空数据同步到服务器的代码

              showNotification("课表已清空", "success");
            }
          });

        // 显示通知
        function showNotification(message, type = "info") {
          // 简单的通知实现，可以替换为更复杂的通知系统
          alert(message);
        }

        // 加载课表数据
        loadScheduleData();
      });
    </script>
  </body>
</html>
